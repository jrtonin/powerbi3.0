---
title: "BI PR Produtivo new version"
author: "Equipe CIGE"
date: "11/08/2021"
output: html_document
---

```{r setup, include=FALSE}

# setting the chunck configuration
knitr::opts_chunk$set(echo = FALSE, 
                      comment = NA,
                      warning = FALSE,
                      error = FALSE, 
                      message = FALSE,
                      tidy = TRUE)

# setting main root in personal drive
print(getwd())
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
dwdir = print(getwd()) # main personal project root

{ 
  # Check if the packages that we need are installed
  want = c("RCurl", "tidyverse", "readr", "zoo", "googledrive", "RCurl", 
           "gsheet", "stringr", "knitr", "data.table")
  have = want %in% rownames(installed.packages())
  # Install the packages that we miss
  if ( any(!have) ) { install.packages( want[!have] ) }
  # Load the packages
  junk <- lapply(want, library, character.only = T)
  # Remove the objects we created
  rm(have, want, junk)
} # Import packages

# setting principal roots (dw + first 3 database words + data type)
dwagrirds = paste0(dwdir, "/db/raw/agricultural")


```

```{r agricultura, include=FALSE}

{
# import city database
code_city = read_delim("C:/Users/jrton/OneDrive/BD/BI/PARAMETERS/GEO/code_city.csv", 
                       ";", escape_double = FALSE, 
                       locale = locale(decimal_mark = ",",
                                       grouping_mark = ".", 
                                       encoding = "ISO-8859-1"),
                       trim_ws = TRUE)

# inseting id variable
code_city = code_city %>% 
  mutate(id = sequence(n())) %>% filter(id > 100 & id <=200)

# creating a list 
temp = code_city 
temp = as.vector(temp)
temp = as.vector(code_city$code)

} # parameters database

{
  
for (file in 1:100){ 

data = get_sidra(x = 3939,
          period = c(last = "10"),
          geo = c("State","City"),
          header = FALSE,
          format = 4,
          geo.filter = list("City" = temp[file], "State" = 41),
          category = list("all"))

# setting the directory      
setwd("C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW") 

# Saving a single object to a file
saveRDS(data, paste(file, ".rds"))
 
} # creating looping for files

{
  
# Step 1: set the working directory (where files are saved)
setwd("C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW") 
  
# Step 2: get all the right file names
file_names = list.files(getwd())
file_names = file_names[grepl(".rds",file_names)]
    
# Step 3: get the read.csv function working
files = readRDS("1 .rds")
    
# Step 4: use lapply to apply the read.csv function to all values of file_names
files = lapply(file_names, readRDS)
list = files
files = rbindlist(files, fill = TRUE)
    
# check structure of new data set
str(files)
    
} # join databases

{ 
  # selecting variables
  data = files %>%
    select(D1C, D2C, D3C, D4C, MC, V) %>%
    filter(V > 0)
  
  # renaming variables
  names(data) = c("code", "year", "code_category", "code_variable", "code_standard", "result")
  
  # including group variable
  data = data %>%
    mutate(code_group = 1)
  
  # exporting database
  write.csv2(data, "C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/DATABASE/dLivestock.csv", 
             row.names=FALSE, na = "")
  
} # organizing database 

{
  # category
  fLivestockCategory = data %>%
    group_by(code_group) %>%
    dplyr::summarise(n = n()) %>% 
    select(-n) %>%
    mutate(group = "PecuÃ¡ria")
  
  # variable
  fLivestockVariable = files %>%
    group_by(D4C, D4N) %>%
    dplyr::summarise(n = n()) %>%
    select(-n)
  
  # renaming variables
  names(fLivestockVariable) = c("code_variable", "variable")
  
  # variable
  fLivestockStandard = files %>%
    group_by(MC, MN) %>%
    dplyr::summarise(n = n()) %>%
    select(-n)
  
  # renaming variables
  names(fLivestockStandard) = c("code_standard", "standard")
  
} # creating filter databases

{

# setting folder  
fold = "C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW"

# getting all files in the directories, recursively
f = list.files(fold, include.dirs = F, full.names = T, recursive = T)

# removing the files
file.remove(f)
  
} # cleaning workspace folder
  
} # livestock database

{
  
for (file in 1:399){ 

data = get_sidra(x = 5457,
          period = c(last = "10"),
          geo = c("State","City"),
          header = FALSE,
          format = 4,
          geo.filter = list("City" = temp[file], "State" = 41),
          category = list("all"),
          classific = "all")

# setting the directory      
setwd("C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW") 

# Saving a single object to a file
saveRDS(data, paste(file, ".rds"))
 
} # creating looping for files

{
  
# Step 1: set the working directory (where files are saved)
setwd("C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW") 
  
# Step 2: get all the right file names
file_names = list.files(getwd())
file_names = file_names[grepl(".rds",file_names)]
    
# Step 3: get the read.csv function working
files = readRDS("1 .rds")
    
# Step 4: use lapply to apply the read.csv function to all values of file_names
files = lapply(file_names, readRDS)
list = files
files = rbindlist(files, fill = TRUE)
    
# check structure of new data set
str(files)
    
} # join databases

{ 
  # selecting variables
  data = files %>%
    select(D1C, D2C, D3C, D4C, MC, V) %>%
    filter(V > 0)
  
  # renaming variables
  names(data) = c("code", "year", "code_category", "code_variable", "code_standard", "result")
  
  # including group variable
  data = data %>%
    mutate(code_group = 2) %>%
    filter(code_variable != 0)
  
  # exporting database
  write.csv2(data, "C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/DATABASE/dFarming.csv", 
             row.names=FALSE, na = "")
  
} # organizing database 

{
  # category
  fFarmingCategory = data %>%
    group_by(code_group) %>%
    dplyr::summarise(n = n()) %>% 
    select(-n) %>%
    mutate(group = "Agricultura")
  
  # variable
  fFarmingVariable = files %>%
    group_by(D4C, D4N) %>%
    dplyr::summarise(n = n()) %>%
    select(-n) %>%
    filter(D4C != 0)
  
  # renaming variables
  names(fFarmingVariable) = c("code_variable", "variable")
  
  # variable
  fFarmingStandard = files %>%
    group_by(MC, MN) %>%
    dplyr::summarise(n = n()) %>%
    select(-n)
  
  # renaming variables
  names(fFarmingStandard) = c("code_standard", "standard")
  
} # creating filter databases
  
{

# setting folder  
fold = "C:/Users/jrton/OneDrive/BD/BI/AGRIBUSINESS/WORKFLOW"

# getting all files in the directories, recursively
f = list.files(fold, include.dirs = F, full.names = T, recursive = T)

# removing the files
file.remove(f)
  
} # cleaning workspace folder

} # farming database

```
