---
title: "Health"
author: "fildalboni"
date: "04/11/2021"
output: html_document
---
---
title: "BI PR Produtivo new version"
author: "Equipe CIGE"
date: "11/08/2021"
output: html_document
---

```{r setup, include=FALSE}

# setting the chunck configuration
knitr::opts_chunk$set(echo = FALSE, 
                      comment = NA,
                      warning = FALSE,
                      error = FALSE, 
                      message = FALSE,
                      tidy = TRUE)

# setting main root in personal drive
print(getwd())
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
dwdir = print(getwd()) # main personal project root

{ 
  # Check if the packages that we need are installed
  want = c("RCurl", "tidyverse", "readr", "zoo", "googledrive", "RCurl", 
           "gsheet", "stringr", "knitr", "data.table", "readxl", "qdapRegex")
  have = want %in% rownames(installed.packages())
  # Install the packages that we miss
  if ( any(!have) ) { install.packages( want[!have] ) }
  # Load the packages
  junk <- lapply(want, library, character.only = T)
  # Remove the objects we created
  rm(have, want, junk)
} # Import packages

# setting principal roots (dw + first 3 database words + data type)
dwagriraw = paste0(dwdir, "/db/raw/agricultural")

```

```{r health}

{
# import city database
fCity = read_delim("C:/Users/CepaTech/Documents/Profissional/SEPL/PowerBi 3/Banco de Dados/citiy/fcity2.csv", 
                       ";", escape_double = FALSE, 
                       locale = locale(decimal_mark = ",",
                                       grouping_mark = ".", 
                                       encoding = "UTF-8"),
                       trim_ws = TRUE)


#Rename columns
colnames(fCity)[1] <- "city_code"

# creating a list 
temp = fCity 
temp = as.vector(temp)
temp = as.vector(fCity$city_code)

# Import population database
fPop <- read_excel("~/Profissional/SEPL/PowerBi 3/Banco de Dados/population/pop_pr.xlsx")

#Rename
colnames(fPop)[1:2] <- c("city", "variable")

fPop <- melt(fPop)

colnames(fPop)[3:4] <- c("year", "parameter")

fPop[, 2] <- "Population"

fPop <- fPop[!is.na(fPop$parameter), ]

} # parameters database


{

  # Step 1: Import hospitalization database
  dHospi <- read.table("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/Hospitalizations.csv",
                       header = TRUE,
                       sep=";",
                       
                       )
  
  # Step 2: Rename columns
  colnames(dHospi)[1:2] <- c("city", "variable")
  colnames(dHospi) <- gsub("X","", colnames(dHospi))
  
  
  
  # Step 3: Join city code with database
  dHospi <- left_join(dHospi, fCity, by = "city")
  
  #Step 4: rearrange dHospi
  dHospi <- dHospi[, c(1, 14, 2:13)]
  
}# Part 1: Import Hospitalization and Join with city_code

{
  # Step 1: Separate variable, group and type columns
  dHospi <- cbind(dHospi, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dHospi$variable),' - '))))
  dHospi <- dHospi[, !colnames(dHospi) == "V2"]
  dHospi <- cbind(dHospi, 
                   as.data.frame(do.call("rbind",
                                         ex_between(dHospi$V3, "(", ")", 
                                                    include.markers = TRUE,
                                                    trim = TRUE,
                                                    ))))
  colnames(dHospi)[15:17] <- c("group", "variable", "standard")
  dHospi <- dHospi[, c(1:2, 15:17, 4:14)]
  dHospi$variable <- gsub("\\s*\\([^\\)]+\\)","", dHospi$variable)
  dHospi$standard <- gsub("[()]", "", dHospi$standard)
  
} # Part 2: Create group_code, variable_code and type_code for Hospitalization

{
 
  # Step 1: Import imunization database
  dImun <- read.delim("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/imunization.csv",
                     sep=";") 
  
  # Step 2: Rename columns
  colnames(dImun)[1:2] <- c("city", "variable")
  colnames(dImun) <- gsub("X","", colnames(dImun))
  
  # Step 3: Join city code with database
  dImun <- left_join(dImun, fCity, by = "city")
  
  #Step 4: rearrange dImun
  dImun <- dImun[, c(1, 14, 2:13)]
  
} # Part 3: Import and clean Imunization

{
  # Step 1: Separate variable, group and type columns
  dImun <- cbind(dImun, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dImun$variable),' - '))))
  
  dImun <- cbind(dImun, 
                   as.data.frame(do.call("rbind",
                                         ex_between(dImun$V2, "(", ")", 
                                                    include.markers = TRUE,
                                                    trim = TRUE,
                                                    ))))
  dImun <- dImun[, -c(17:19)]
  colnames(dImun)[15:17] <- c("group", "variable", "standard")
  dImun <- dImun[, c(1:2, 15:17, 4:14)]
  dImun$variable <- gsub("\\s*\\([^\\)]+\\)","", dImun$variable)
  dImun$standard <- gsub("[()]", "", dImun$standard)
  
} # Part 4: Create Variable and Group Code

{
 
  # Step 1: Import Leitos database
  dLeitos <- read.delim("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/leitos.csv",
                     sep=";") 
  
  # Step 2: Rename columns
  colnames(dLeitos)[1:2] <- c("city", "variable")
  colnames(dLeitos) <- gsub("X","", colnames(dLeitos))
  
  # Step 3: Join city code with database
  dLeitos <- left_join(dLeitos, fCity, by = "city")
  
  #Step 4: rearrange dLeitos
  dLeitos <- dLeitos[, c(1, 14, 2:13)]
  
} # Part 5: Import and clean Leitos

{
  # Step 1: Separate variable, group and type columns
  dLeitos <- cbind(dLeitos, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dLeitos$variable),' - '))))
  
  dLeitos <- unite(dLeitos, "variable", c("V2", "V3"), sep = " ", remove = TRUE)
  dLeitos$variable <- gsub("Existente", "", dLeitos$variable)
  dLeitos$standard <- "pessoas"
  colnames(dLeitos)[14] <- "group"
  dLeitos <- dLeitos[, c(1:2, 14:16, 3:13)]
  
} # Part 6: Create Variable and Group

{
 
  # Step 1: Import mortality database
  dMorta <- read.delim("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/mortality.csv",
                     sep=";") 
  
  # Step 2: Rename columns
  colnames(dMorta)[1:2] <- c("city", "variable")
  colnames(dMorta) <- gsub("X","", colnames(dMorta))
  
  # Step 3: Join city code with database
  dMorta <- left_join(dMorta, fCity, by = "city")
  
  #Step 4: rearrange dMorta
  dMorta <- dMorta[, c(1, 14, 2:13)]
  
} # Part 7: Import and clean Imunization

{
  # Step 1: Separate variable, group and type columns
  dMorta <- cbind(dMorta, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dMorta$variable),' - '))))
  
  dMorta <- unite(dMorta, "variable", c("V2", "V3"), sep = " ", remove = TRUE)
  dMorta$standard <- "pessoas"
  colnames(dMorta)[14] <- "group"
  dMorta <- dMorta[, c(1:2, 14:16, 3:13)]
  
} # Part 8: Create Variable and Group Code

{
 
  # Step 1: Import professionals database
  dProfi <- read.delim("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/professionals.csv",
                     sep=";") 
  
  # Step 2: Rename columns
  colnames(dProfi)[1:2] <- c("city", "variable")
  colnames(dProfi) <- gsub("X","", colnames(dProfi))
  
  # Step 3: Join city code with database
  dProfi <- left_join(dProfi, fCity, by = "city")
  
  #Step 4: rearrange dProfi
  dProfi <- dProfi[, c(1, 14, 2:13)]
  
} # Part 9: Import and clean professional

{
  # Step 1: Separate variable, group and type columns
  dProfi <- cbind(dProfi, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dProfi$variable),' - '))))
  dProfi$standard <- "pessoas"
  dProfi <- dProfi[, c(1:2, 15:17, 4:14)]
  colnames(dProfi)[3:4] <- c("group", "variable")
  
} # Part 10: Create Variable and Group Code

{
 
  # Step 1: Import expenses database
  dExpen <- read.delim("~/Profissional/SEPL/PowerBi 3/Banco de Dados/health/expenses.csv",
                     sep=";") 
  
  # Step 2: Rename columns
  colnames(dExpen)[1:2] <- c("city", "variable")
  colnames(dExpen) <- gsub("X","", colnames(dExpen))
  
  # Step 3: Join city code with database
  dExpen <- left_join(dExpen, fCity, by = "city")
  
  #Step 4: rearrange dExpen
  dExpen <- dExpen[, c(1, 14, 2:13)]
  
} # Part 11: Import and clean Expenses

{
  # Step 1: Separate variable, group and type columns
  dExpen <- cbind(dExpen, 
                   as.data.frame(do.call("rbind", strsplit(as.character(dExpen$variable),' - '))))
  dExpen <- cbind(dExpen, 
                   as.data.frame(do.call("rbind",
                                         ex_between(dExpen$V2, "(", ")", 
                                                    include.markers = TRUE,
                                                    trim = TRUE,
                                                    ))))
  
  
  # Step 2: Rename and rearrange Columns
  colnames(dExpen)[15:17] <- c("group", "variable", "standard")
  dExpen <- dExpen[, c(1:2, 15:17, 4:14)]
  
  # Step 3: Eliminate problematic symbols
  dExpen$variable <- gsub("\\s*\\([^\\)]+\\)","", dExpen$variable)
  dExpen$standard <- gsub("[()]", "", dExpen$standard)
  dExpen$group <- "Despesas Municipais"
  
} # Part 12: Create variable and group

{
  # Step 1: Bind all health databases
  dHealth <- rbind(dExpen, dHospi, dImun, dLeitos, dMorta, dProfi)
  
  # Step 2: Remove previous databases
  remove(dExpen, dHospi, dImun, dLeitos, dMorta, dProfi)
  
} # Part 13: Bind all databases

{
  # Step 1: Create fGroup with codes
  fHealthGroup <- data.frame(unique(dHealth$group)) %>%
    mutate(group_code = sequence(n()))
  colnames(fHealthGroup)[1] <- "group"
  
  # Step 2: Create fvariable with codes
  fHealthVariable <- data.frame(unique(dHealth$variable)) %>%
    mutate(variable_code = sequence(n()))
  colnames(fHealthVariable)[1] <- "variable"
  
  # Step 3: Transform Nas into Pessoas
  dHealth$standard <- case_when(is.na(dHealth$standard) ~"pessoas",
                                TRUE ~as.character(dHealth$standard))
  fHealthStand <- data.frame(unique(dHealth$standard)) %>%
    mutate(standar_code = sequence(n()))
  colnames(fHealthStand)[1] <- "standard"
    
} # Part 14: Create Codes for Group, variable and standard 

{

  # Step 1: Join Group_code
  dHealth <- left_join(dHealth, fHealthGroup, by = "group", keep = FALSE)
  
  # Step 2: Join variable_code
  dHealth <- left_join(dHealth, fHealthVariable, by = "variable", keep = FALSE)
  
  # Step 3: Join standard_code
  dHealth <- left_join(dHealth, fHealthStand, by = "standard", keep = FALSE)
  
  # Step 4: Clean dHealth
  dHealth <- dHealth[, c(1:2, 17:19, 6:16)]
  
} # Part 15: Join all codes with dHealth

{
  
  # Step 1: Turn columns into one single column called year and the values as result
  dHealth <- gather(dHealth, key = "year", value = "result", c("2010":"2020"))
  
} # Part 16: Gather database

```






{
  # Step 2: Create column group_code
  dHospi$group <- "Hospitalization"
  dHospi$group_code <- 1
  
  # Step 3: Create column variable_code
  dHospi <- dHospi %>%
    group_by(city) %>%
    mutate(variable_code = sequence(n()))
  
  # Step 4: Create standard_code column
  dHospi$standard <- case_when(is.na(dHospi$standard) ~ "pessoas", TRUE ~ dHospi$standard) 
  standard <- unique(dHospi$standard)
  fstand <- as.data.frame(standard) %>%
    mutate(standard_code = sequence(n()))
  dHospi <- left_join(dHospi, fstand, by = "standard")
  
  # Step 5: Create type_code column
  dHospi$type_code <- if_else(dHospi$standard == "%", 2,
                              1) 
  type <- c("absoluto", "taxa")
  type_code <- 1:2
  ftype <- data.frame(type, type_code)
} # How to create codes


```
